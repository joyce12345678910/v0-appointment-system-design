â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        EMAIL VERIFICATION FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BEFORE (BROKEN):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

User Signs Up
    â”‚
    â–¼
Generate 6-digit code
    â”‚
    â–¼
Store in database âœ…
    â”‚
    â–¼
Try to send email âŒ (NOTHING HAPPENS - CODE LOST)
    â”‚
    â–¼
User never receives code
    â”‚
    â–¼
Can't verify email
    â”‚
    â–¼
Account creation fails âŒ


AFTER (FIXED):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

User Signs Up with email & password
    â”‚
    â–¼
POST /api/auth/send-verification-code
    â”‚
    â”œâ”€â–º Generate 6-digit code
    â”‚
    â”œâ”€â–º Store in database âœ…
    â”‚
    â””â”€â–º Call sendVerificationCodeEmail()
            â”‚
            â”œâ”€â–º Check for RESEND_API_KEY
            â”‚
            â”œâ”€ If API key exists:
            â”‚  â”‚
            â”‚  â””â”€â–º Send via Resend API âœ…
            â”‚      User receives real email
            â”‚
            â””â”€ If no API key:
               â”‚
               â””â”€â–º Log to server console âœ…
                   Developer sees code in logs
    â”‚
    â–¼
Redirect to /auth/verify-email?email=user@gmail.com
    â”‚
    â–¼
User enters 6-digit code
    â”‚
    â–¼
POST /api/auth/verify-code
    â”‚
    â”œâ”€â–º Look up code in database
    â”‚
    â”œâ”€â–º Verify it matches
    â”‚
    â”œâ”€â–º Check if expired
    â”‚
    â””â”€â–º If valid: Mark as verified âœ…
    â”‚
    â–¼
User calls supabase.auth.signUp()
    â”‚
    â–¼
Create account in Supabase âœ…
    â”‚
    â–¼
Create profile in database âœ…
    â”‚
    â–¼
Redirect to /auth/sign-up-success âœ…
    â”‚
    â–¼
User can now login and book appointments âœ…


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                          VERIFICATION CODE FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DEVELOPMENT MODE (No Setup Required):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. sendVerificationCodeEmail(email, code)
           â–¼
   if (!RESEND_API_KEY) {
           â–¼
   console.log("[DEVELOPMENT MODE] Verification Code...")
           â–¼
   Developer sees in server console:
   
   [DEVELOPMENT MODE] Verification Code for user@gmail.com
   ğŸ“§ Email: user@gmail.com
   ğŸ” Code: 123456  â† COPY THIS
   â±ï¸  Expires in: 10 minutes
           â–¼
   Copy code and paste in app


PRODUCTION MODE (With Resend API Key):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. sendVerificationCodeEmail(email, code)
           â–¼
   if (RESEND_API_KEY) {
           â–¼
   fetch("https://api.resend.com/emails", {
     method: "POST",
     headers: Authorization: Bearer {RESEND_API_KEY}
     body: {
       from: "noreply@domain.com",
       to: "user@gmail.com",
       subject: "Your Verification Code",
       html: "Beautiful formatted email with 6-digit code"
     }
   })
           â–¼
   User receives email in Gmail âœ…
           â–¼
   User copies code from email and pastes in app


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        FILE INTERACTION DIAGRAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

USER INTERFACE:
  /app/auth/sign-up/page.tsx  â”€ Fill form & click Sign Up
              â”‚
              â–¼
  /api/auth/send-verification-code/route.ts â”€ Generate & store code
              â”‚
              â”œâ”€â–º Generate 6-digit code
              â”‚
              â”œâ”€â–º Store in DB: email_verification_codes table
              â”‚
              â””â”€â–º Import & call:
                  /lib/email.ts â†’ sendVerificationCodeEmail()
                        â”‚
                        â”œâ”€ Check RESEND_API_KEY env var
                        â”‚
                        â”œâ”€ Development: Log to console
                        â”‚
                        â””â”€ Production: Send via Resend API
              â”‚
              â–¼
  /app/auth/verify-email/page.tsx  â”€ User enters code
              â”‚
              â–¼
  /api/auth/verify-code/route.ts  â”€ Validate code
              â”‚
              â”œâ”€â–º Look up in email_verification_codes table
              â”‚
              â”œâ”€â–º Check if matches & not expired
              â”‚
              â””â”€â–º Mark as verified
              â”‚
              â–¼
  Create account in Supabase Auth âœ…
  Create profile in database âœ…
              â”‚
              â–¼
  /app/auth/sign-up-success/page.tsx  â”€ Success page
              â”‚
              â–¼
  User can now LOGIN! âœ…


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        ENVIRONMENT VARIABLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DEVELOPMENT (No setup needed):
  âœ… Works without any env vars
  âœ… Code logs to server console
  âœ… Perfect for testing

PRODUCTION (Optional):
  RESEND_API_KEY     â†’ Get from https://resend.com
  SENDER_EMAIL       â†’ Your sender email (default: noreply@tactaybilledo.com)

If not set: Falls back to development console logging


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        DATABASE TABLES INVOLVED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

email_verification_codes:
  â”œâ”€ id (primary key)
  â”œâ”€ email (the user's email)
  â”œâ”€ code (6-digit verification code)
  â”œâ”€ expires_at (when code expires)
  â”œâ”€ verified (whether code was used)
  â””â”€ created_at (timestamp)

profiles:
  â”œâ”€ id (user ID from Supabase Auth)
  â”œâ”€ full_name
  â”œâ”€ phone
  â”œâ”€ date_of_birth
  â”œâ”€ address
  â”œâ”€ role ("patient" or "doctor" or "admin")
  â””â”€ created_at

auth.users (Supabase):
  â”œâ”€ id
  â”œâ”€ email
  â”œâ”€ encrypted_password
  â””â”€ email_confirmed


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
